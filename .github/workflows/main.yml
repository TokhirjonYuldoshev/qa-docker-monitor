name: Cloud QA Monitor üöÄ

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å? (–ü—Ä–∏ –ø—É—à–µ –∫–æ–¥–∞)
on: [push]

jobs:
  test-database:
    runs-on: ubuntu-latest # –ë–µ—Ä–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä —Å Linux

    # üî• –í–æ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å!
    # –ú—ã –ø—Ä–æ—Å–∏–º GitHub –ø–æ–¥–Ω—è—Ç—å PostgreSQL –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –≤ –æ–±–ª–∞–∫–µ
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_PASSWORD: mysecretpassword
        ports:
          - 5432:5432
        # –ñ–¥–µ–º, –ø–æ–∫–∞ –±–∞–∑–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è (Healthcheck)
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: üì• –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v3

      - name: üõ† –°—Ç–∞–≤–∏–º –∫–ª–∏–µ–Ω—Ç Postgres
        run: sudo apt-get install -y postgresql-client

      - name: üß™ –ó–ê–ü–£–°–ö –¢–ï–°–¢–ê (SQL Insert)
        run: |
          # –ü—Ä–æ–±—É–µ–º –≤—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –æ–±–ª–∞—á–Ω—É—é –±–∞–∑—É
          PGPASSWORD=mysecretpassword psql -h localhost -U postgres -c "CREATE TABLE IF NOT EXISTS robot_log (id SERIAL PRIMARY KEY, status TEXT, visit_time TIMESTAMP DEFAULT NOW());"
          PGPASSWORD=mysecretpassword psql -h localhost -U postgres -c "INSERT INTO robot_log (status) VALUES ('GitHub Cloud Test - OK');"

      - name: ‚úÖ –£–°–ü–ï–• - –®–ª–µ–º –≤ Telegram
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d text="‚òÅÔ∏è OBLAKO: Test uspeshen! Baza v GitHub rabotaet."

      - name: üö® –û–®–ò–ë–ö–ê - –®–ª–µ–º –≤ Telegram
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d text="üî• OBLAKO: Test upal! Baza nedostupna."