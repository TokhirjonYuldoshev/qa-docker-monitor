name: Cloud QA Monitor üöÄ

# –¢–†–ò–ì–ì–ï–†–´: –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å?
on:
  push:                   # 1. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞
  workflow_dispatch:      # 2. –ü–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "Run workflow" (–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
  schedule:
    - cron: '*/10 * * * *' # 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

jobs:
  test-database:
    runs-on: ubuntu-latest # –ò—Å–ø–æ–ª—å–∑—É–µ–º Linux —Å–µ—Ä–≤–µ—Ä GitHub

    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∞
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_PASSWORD: mysecretpassword
        ports:
          - 5432:5432
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è: –∂–¥–µ–º, –ø–æ–∫–∞ –±–∞–∑–∞ —Å–∫–∞–∂–µ—Ç "–Ø –≥–æ—Ç–æ–≤–∞!"
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: üì• –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: ‚è≥ –°—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω–∞—è –ø–∞—É–∑–∞ (—á—Ç–æ–±—ã –±–∞–∑–∞ —Ç–æ—á–Ω–æ –ø—Ä–æ—Å–Ω—É–ª–∞—Å—å)
        run: sleep 10

      - name: üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ Postgres
        run: sudo apt-get install -y postgresql-client

      - name: üß™ –ó–ê–ü–£–°–ö –¢–ï–°–¢–ê (SQL Insert)
        env:
          PGPASSWORD: mysecretpassword
        run: |
          # 1. –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          psql -h localhost -U postgres -c "CREATE TABLE IF NOT EXISTS robot_log (id SERIAL PRIMARY KEY, status TEXT, visit_time TIMESTAMP DEFAULT NOW());"
          
          # 2. –ü—Ä–æ–±—É–µ–º –≤—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–°–∞–º –¢–µ—Å—Ç)
          psql -h localhost -U postgres -c "INSERT INTO robot_log (status) VALUES ('GitHub Cloud Test - OK');"

      - name: ‚úÖ –£–°–ü–ï–• - –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage \
          -d chat_id=$TG_CHAT_ID \
          -d text="‚òÅÔ∏è OBLAKO: Vse rabotaet! Proverka proshla uspeshno."

      - name: üö® –û–®–ò–ë–ö–ê - –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
        if: failure()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage \
          -d chat_id=$TG_CHAT_ID \
          -d text="üî• OBLAKO: –û–®–ò–ë–ö–ê! Test upal. Baza nedostupna."