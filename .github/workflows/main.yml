name: Cloud QA Monitor üöÄ

on: [push]

jobs:
  test-database:
    runs-on: ubuntu-latest

    # –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL –≤ –æ–±–ª–∞–∫–µ
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_PASSWORD: mysecretpassword
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: üì• –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v3

      - name: üõ† –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –±–∞–∑—ã (30 —Å–µ–∫)
        run: sleep 30

      - name: üõ† –°—Ç–∞–≤–∏–º –∫–ª–∏–µ–Ω—Ç Postgres
        run: sudo apt-get install -y postgresql-client

      - name: üß™ –ó–ê–ü–£–°–ö –¢–ï–°–¢–ê (SQL Insert)
        run: |
          # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
          PGPASSWORD=mysecretpassword psql -h localhost -U postgres -c "CREATE TABLE IF NOT EXISTS robot_log (id SERIAL PRIMARY KEY, status TEXT, visit_time TIMESTAMP DEFAULT NOW());"
          # –í—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
          PGPASSWORD=mysecretpassword psql -h localhost -U postgres -c "INSERT INTO robot_log (status) VALUES ('GitHub Cloud Test - OK');"

      - name: ‚úÖ –£–°–ü–ï–• - –®–ª–µ–º –≤ Telegram
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage \
          -d chat_id=$TG_CHAT_ID \
          -d text="‚òÅÔ∏è OBLAKO: Test uspeshen! Baza v GitHub rabotaet."

      - name: üö® –û–®–ò–ë–ö–ê - –®–ª–µ–º –≤ Telegram
        if: failure()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage \
          -d chat_id=$TG_CHAT_ID \
          -d text="üî• OBLAKO: Test upal! Prover logi GitHub."